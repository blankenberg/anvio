<tool id="anvi_merge" name="anvi-merge" version="5.3">
    <description>Merge multiple anvio profiles</description>
    <requirements>
        <requirement type="package" version="5.3">anvio</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <version_command>anvi-merge --version</version_command>
    <command><![CDATA[
        cp -R '${input_contigs_db.extra_files_path}' '${output_contigs_db.extra_files_path}'
 &&
 anvi-merge

            #for $gxy_input in $input:
                 '${gxy_input.extra_files_path}/PROFILE.db'
            #end for
            
--contigs-db '${output_contigs_db.extra_files_path}/CONTIGS.db'


#if $output_dir:
    --output-dir '${output_dir.extra_files_path}'
#end if


#if $str( $sample_name ):
    --sample-name '${sample_name}'
#end if


#if $description:
    --description '${description}'
#end if

${skip_hierarchical_clustering}

${enforce_hierarchical_clustering}


#if $str( $distance ):
    --distance '${distance}'
#end if


#if $str( $linkage ):
    --linkage '${linkage}'
#end if

${skip_concoct_binning}

${overwrite_output_destinations}

&> '${GALAXY_ANVIO_LOG}'

    ]]></command>
    <inputs>
        <param name="input" type="data" label="Input" format="anvio_profile_db" optional="True" multiple="True" argument="" help="Anvo'o single profiles to merge"/>
        <param name="input_contigs_db" type="data" label="Contigs Db" format="anvio_contigs_db" optional="False" multiple="False" argument="--contigs-db" help="Anvi'o contigs database generated by 'anvi-gen-contigs'"/>
        <param name="sample_name" type="text" label="Sample Name" value="" optional="True" argument="--sample-name" help="It is important to set a sample name (using only ASCII letters and digits and without spaces) that is unique (considering all others). If you do not provide one, anvi'o will try to make up one for you based on other information, although, you should never let the software to decide these things)."/>
        <param name="description" type="data" label="Description" format="tabular" optional="True" multiple="False" argument="--description" help="A plain text file that contains some description about the project. You can use Markdwon syntax. The description text will be rendered and shown in all relevant interfaces, including the anvi'o interactive interface, or anvi'o summary outputs."/>
        <param name="skip_hierarchical_clustering" type="boolean" label="Skip Hierarchical Clustering" truevalue="--skip-hierarchical-clustering" falsevalue="" checked="False" optional="True" argument="--skip-hierarchical-clustering" help="If you are not planning to use the interactive interface (or if you have other means to add a tree of contigs in the database) you may skip the step where hierarchical clustering of your items are preformed based on default clustering recipes matching to your database type."/>
        <param name="enforce_hierarchical_clustering" type="boolean" label="Enforce Hierarchical Clustering" truevalue="--enforce-hierarchical-clustering" falsevalue="" checked="False" optional="True" argument="--enforce-hierarchical-clustering" help="If you have more than 25,000 splits in your merged profile, anvi-merge will automatically skip the hierarchical clustering of splits (by setting --skip-hierarchical-clustering flag on). This is due to the fact that computational time required for hierarchical clustering increases exponentially with the number of items being clustered. Based on our experience we decided that 25,000 splits is about the maximum we should try. However, this is not a theoretical limit, and you can overwrite this heuristic by using this flag, which would tell anvi'o to attempt to cluster splits regardless."/>
        <param name="distance" type="text" label="Distance" value="" optional="True" argument="--distance" help='The distance metric for the hierarchical clustering. If you do not use this flag, the default distance metric will be used for each clustering configuration which is "euclidean".'/>
        <param name="linkage" type="text" label="Linkage" value="" optional="True" argument="--linkage" help="The same story with the `--distance`, except, the system default for this one is ward."/>
        <param name="skip_concoct_binning" type="boolean" label="Skip Concoct Binning" truevalue="--skip-concoct-binning" falsevalue="" checked="False" optional="True" argument="--skip-concoct-binning" help="Anvi'o uses CONCOCT (Alneberg et al.) by default for unsupervised genome binning for merged runs. CONCOCT results are stored in the profile database, which then can be used from within appropriate interfaces (i.e., anvi-interactive, anvi-summary, etc). Use this flag if you would like to skip this step"/>
        <param name="overwrite_output_destinations" type="boolean" label="Overwrite Output Destinations" truevalue="--overwrite-output-destinations" falsevalue="" checked="False" optional="True" argument="--overwrite-output-destinations" help="Overwrite if the output files and/or directories exist."/>
    </inputs>
    <outputs>
        <data name="output_contigs_db" format="anvio_contigs_db" format_source="input_contigs_db" metadata_source="input_contigs_db" label="${tool.name} on ${on_string}: Contigs Db"/>
        <data name="output_dir" format="anvio_profile_db" format_source="input_output_dir" metadata_source="input_output_dir" label="${tool.name} on ${on_string}: Output Dir"/>
        <data name="GALAXY_ANVIO_LOG" format="txt" label="${tool.name} on ${on_string}: Log"/>
    </outputs>
    <help><![CDATA[
        usage: anvi-merge [-h] -c CONTIGS_DB [-o DIR_PATH] [-S NAME]
                              [--description TEXT_FILE]
                              [--skip-hierarchical-clustering]
                              [--enforce-hierarchical-clustering]
                              [--distance DISTANCE_METRIC]
                              [--linkage LINKAGE_METHOD]
                              [--skip-concoct-binning] [-W]
                              SINGLE_PROFILES) [SINGLE_PROFILE(S ...]

Merge multiple anvio profiles

positional arguments:
  SINGLE_PROFILE(S)     Anvo'o single profiles to merge

optional arguments:
  -h, --help            show this help message and exit
  -c CONTIGS_DB, --contigs-db CONTIGS_DB
                        Anvi'o contigs database generated by 'anvi-gen-
                        contigs'
  -o DIR_PATH, --output-dir DIR_PATH
                        Directory path for output files
  -S NAME, --sample-name NAME
                        It is important to set a sample name (using only ASCII
                        letters and digits and without spaces) that is unique
                        (considering all others). If you do not provide one,
                        anvi'o will try to make up one for you based on other
                        information, although, you should never let the
                        software to decide these things).
  --description TEXT_FILE
                        A plain text file that contains some description about
                        the project. You can use Markdwon syntax. The
                        description text will be rendered and shown in all
                        relevant interfaces, including the anvi'o interactive
                        interface, or anvi'o summary outputs.
  --skip-hierarchical-clustering
                        If you are not planning to use the interactive
                        interface (or if you have other means to add a tree of
                        contigs in the database) you may skip the step where
                        hierarchical clustering of your items are preformed
                        based on default clustering recipes matching to your
                        database type.
  --enforce-hierarchical-clustering
                        If you have more than 25,000 splits in your merged
                        profile, anvi-merge will automatically skip the
                        hierarchical clustering of splits (by setting --skip-
                        hierarchical-clustering flag on). This is due to the
                        fact that computational time required for hierarchical
                        clustering increases exponentially with the number of
                        items being clustered. Based on our experience we
                        decided that 25,000 splits is about the maximum we
                        should try. However, this is not a theoretical limit,
                        and you can overwrite this heuristic by using this
                        flag, which would tell anvi'o to attempt to cluster
                        splits regardless.
  --distance DISTANCE_METRIC
                        The distance metric for the hierarchical clustering.
                        If you do not use this flag, the default distance
                        metric will be used for each clustering configuration
                        which is "euclidean".
  --linkage LINKAGE_METHOD
                        The same story with the `--distance`, except, the
                        system default for this one is ward.
  --skip-concoct-binning
                        Anvi'o uses CONCOCT (Alneberg et al.) by default for
                        unsupervised genome binning for merged runs. CONCOCT
                        results are stored in the profile database, which then
                        can be used from within appropriate interfaces (i.e.,
                        anvi-interactive, anvi-summary, etc). Use this flag if
                        you would like to skip this step
  -W, --overwrite-output-destinations
                        Overwrite if the output files and/or directories
                        exist.

    ]]></help>
    <citations>
        <citation type="doi">10.7717/peerj.1319</citation>
        <citation type="bibtex">@ARTICLE{Blankenberg19-anvio,
   author = {Daniel Blankenberg, et al},
   title = {In preparation..},
   }</citation>
    </citations>
</tool>