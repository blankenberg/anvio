<tool id="anvi_profile" name="anvi-profile" version="5.2">
    <description>Main entry point for Post-Assembly Metagenomics Pipeline</description>
    <requirements>
        <requirement type="package" version="5.2">anvio</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <version_command>anvi-profile --version</version_command>
    <command><![CDATA[
        
    #if $input_file:
        ln -s '${input_file}' 'input_file.bam' && ln -s '${input_file.metadata.bam_index}' 'input_file.bam.bai'
    #else
        echo ''
    #end if
 && 

    #if $input_contigs_db:
        cp -R '${input_contigs_db.extra_files_path}' '${output_contigs_db.extra_files_path}'
    #else
        echo ''
    #end if
 &&
 anvi-profile

#if $input_file:
    --input-file 'input_file.bam'
#end if

--contigs-db '${output_contigs_db.extra_files_path}/CONTIGS.db'

${blank_profile}


#if $output_dir:
    --output-dir '${output_dir.extra_files_path}'
#end if

${overwrite_output_destinations}


#if $str( $sample_name ):
    --sample-name '${sample_name}'
#end if

${report_variability_full}

${skip_SNV_profiling}

${profile_SCVs}


#if $description:
    --description '${description}'
#end if

${include_orphans}

${cluster_contigs}

${skip_hierarchical_clustering}


#if $str( $distance ):
    --distance '${distance}'
#end if


#if $str( $linkage ):
    --linkage '${linkage}'
#end if


#if $str( $min_contig_length ):
    --min-contig-length '${min_contig_length}'
#end if


#if $str( $max_contig_length ):
    --max-contig-length '${max_contig_length}'
#end if


#if $str( $min_mean_coverage ):
    --min-mean-coverage '${min_mean_coverage}'
#end if


#if $str( $min_coverage_for_variability ):
    --min-coverage-for-variability '${min_coverage_for_variability}'
#end if

${list_contigs}


#if $contigs_of_interest:
    --contigs-of-interest '${contigs_of_interest}'
#end if

--num-threads "\${GALAXY_SLOTS:-1}"


#if $str( $queue_size ):
    --queue-size '${queue_size}'
#end if


#if $str( $write_buffer_size ):
    --write-buffer-size '${write_buffer_size}'
#end if

&> '${GALAXY_ANVIO_LOG}'

 &&
ls -lahR
    ]]></command>
    <inputs>
        <param name="input_file" type="data" label="Input File" format="bam" optional="True" multiple="False" argument="--input-file" help="Sorted and indexed BAM file to analyze. Takes a long time depending on the length of the file and parameters used for profiling."/>
        <param name="input_contigs_db" type="data" label="Contigs Db" format="anvio_contigs_db" optional="True" multiple="False" argument="--contigs-db" help="Anvi'o contigs database generated by 'anvi-gen-contigs'"/>
        <param name="blank_profile" type="boolean" label="Blank Profile" truevalue="--blank-profile" falsevalue="" checked="False" optional="True" argument="--blank-profile" help="If you only have contig sequences, but no mapping data (i.e., you found a genome and would like to take a look from it), this flag will become very hand. After creating a contigs database for your contigs, you can create a blank anvi'o profile database to use anvi'o interactive interface with that contigs database without any mapping data."/>
        <param name="overwrite_output_destinations" type="boolean" label="Overwrite Output Destinations" truevalue="--overwrite-output-destinations" falsevalue="" checked="False" optional="True" argument="--overwrite-output-destinations" help="Overwrite if the output files and/or directories exist."/>
        <param name="sample_name" type="text" label="Sample Name" value="" optional="True" argument="--sample-name" help="It is important to set a sample name (using only ASCII letters and digits and without spaces) that is unique (considering all others). If you do not provide one, anvi'o will try to make up one for you based on other information, although, you should never let the software to decide these things)."/>
        <param name="report_variability_full" type="boolean" label="Report Variability Full" truevalue="--report-variability-full" falsevalue="" checked="False" optional="True" argument="--report-variability-full" help="One of the things anvi-profile does is to store information about variable nucleotide positions. Usually it does not report every variable position, since not every variable position is geniune variation. Say, if you have 1,000 coverage, and all nucleotides at that position are Ts and only one of them is a C, the confidence of that C being a real variation is quite low. anvio has a simple algorithm in place to reduce the impact of noise. However, using this flag you can diable it and ask profiler to report every single variation (which may result in very large output files and millions of reports, but you are the boss). Do not forget to take a look at '--min-coverage-for-variability' parameter"/>
        <param name="skip_SNV_profiling" type="boolean" label="Skip Snv Profiling" truevalue="--skip-SNV-profiling" falsevalue="" checked="False" optional="True" argument="--skip-SNV-profiling" help="By default, anvi'o characterizes single-nucleotide variation in each sample. The use of this flag will instruct profiler to skip that step. Please remember that parameters and flags must be identical between different profiles using the same contigs database for them to merge properly."/>
        <param name="profile_SCVs" type="boolean" label="Profile Scvs" truevalue="--profile-SCVs" falsevalue="" checked="False" optional="True" argument="--profile-SCVs" help="Anvi'o can perform accurate characterization of codon frequencies in genes during profiling. While having codon frequencies opens doors to powerful evolutionary insights in downstream analyses, due to its computational complexity, this feature comes 'off' by default. Using this flag you can rise against the authority as you always should, and make anvi'o profile codons."/>
        <param name="description" type="data" label="Description" format="tabular" optional="True" multiple="False" argument="--description" help="A plain text file that contains some description about the project. You can use Markdwon syntax. The description text will be rendered and shown in all relevant interfaces, including the anvi'o interactive interface, or anvi'o summary outputs."/>
        <param name="include_orphans" type="boolean" label="Include Orphans" truevalue="--include-orphans" falsevalue="" checked="False" optional="True" argument="--include-orphans" help="Include orphans (paired reads that are not in a proper pair). The default is to ignore orphans."/>
        <param name="cluster_contigs" type="boolean" label="Cluster Contigs" truevalue="--cluster-contigs" falsevalue="" checked="False" optional="True" argument="--cluster-contigs" help="Single profiles are rarely used for genome binning or visualization, and since clustering step increases the profiling runtime for no good reason, the default behavior is to not cluster contigs for individual runs. However, if you are planning to do binning on one sample, you must use this flag to tell anvio to run cluster configurations for single runs on your sample."/>
        <param name="skip_hierarchical_clustering" type="boolean" label="Skip Hierarchical Clustering" truevalue="--skip-hierarchical-clustering" falsevalue="" checked="False" optional="True" argument="--skip-hierarchical-clustering" help="If you are not planning to use the interactive interface (or if you have other means to add a tree of contigs in the database) you may skip the step where hierarchical clustering of your items are preformed based on default clustering recipes matching to your database type."/>
        <param name="distance" type="text" label="Distance" value="euclidean" optional="True" argument="--distance" help='The distance metric for the hierarchical clustering. Only relevant if you are using `--cluster-contigs` flag. The default is "%(default)s".'/>
        <param name="linkage" type="text" label="Linkage" value="ward" optional="True" argument="--linkage" help='The linkage method for the hierarchical clustering. Just like the distance metric this is only relevant if you are using it with `--cluster-contigs` flag. The default is "%(default)s".'/>
        <param name="min_contig_length" type="integer" label="Min Contig Length" value="1000" optional="True" argument="--min-contig-length" help="Minimum length of contigs in a BAM file to analyze. The minimum length should be long enough for tetra-nucleotide frequency analysis to be meaningful. There is no way to define a golden number of minumum length that would be applicable to genomes found in all environments, but we chose the default to be %(default)d, and have been happy with it. You are welcome to experiment, but we advise to never go below 1,000. You also should remember that the lower you go, the more time it will take to analyze all contigs. You can use --list-contigs parameter to have an idea how many contigs would be discarded for a given M."/>
        <param name="max_contig_length" type="integer" label="Max Contig Length" value="0" optional="True" argument="--max-contig-length" help="Just like the minimum contig length parameter, but to set a maximum. Basically this will remove any contig longer than a certain value. Why would anyone need this? Who knows. But if you ever do, it is here."/>
        <param name="min_mean_coverage" type="integer" label="Min Mean Coverage" value="0" optional="True" argument="--min-mean-coverage" help="Minimum mean coverage for contigs to be kept in the analysis. The default value is %(default)d, which is for your best interest if you are going to profile muptiple BAM files which are then going to be merged for a cross-sectional or time series analysis. Do not change it if you are not sure this is what you want to do."/>
        <param name="min_coverage_for_variability" type="integer" label="Min Coverage For Variability" value="10" optional="True" argument="--min-coverage-for-variability" help="Minimum coverage of a nucleotide position to be subjected to SNV profiling. By default, anvio will not attempt to make sense of variation in a given nucleotide position if it is covered less than %(default)dX. You can change that minimum using this parameter."/>
        <param name="list_contigs" type="boolean" label="List Contigs" truevalue="--list-contigs" falsevalue="" checked="False" optional="True" argument="--list-contigs" help="When declared, the program will list contigs in the BAM file and exit gracefully without any further analysis."/>
        <param name="contigs_of_interest" type="data" label="Contigs Of Interest" format="txt" optional="True" multiple="False" argument="--contigs-of-interest" help="It is possible to analyze only a group of contigs from a given BAM file. If you provide a text file, in which every contig of interest is listed line by line, the profiler would engine only on those contigs in the BAM file and ignore the rest. This can be used for debugging purposes, or to engine on a particular group of contigs that were identified as relevant during the interactive analysis."/>
        <param name="queue_size" type="integer" label="Queue Size" value="0" optional="True" argument="--queue-size" help="The queue size for worker threads to store data to communicate to the main thread. The default is set by the class based on the number of threads. If you have *any* hesitation about whther you know what you are doing, you should not change this value."/>
        <param name="write_buffer_size" type="integer" label="Write Buffer Size" value="500" optional="True" argument="--write-buffer-size" help="How many items should be kept in memory before they are written do the disk. The default is %(default)d. The larger the buffer size, the less frequent the program will access to the disk, yet the more memory will be consumed since the processed items will be cleared off the memory only after they are written to the disk. The default buffer size will likely work for most cases, but if you have very large contigs, you may need to decrease this value. Please keep an eye on the memory usage output to make sure the memory use never exceeds the size of the physical memory."/>
    </inputs>
    <outputs>
        <data name="output_contigs_db" format="anvio_contigs_db" format_source="input_contigs_db" metadata_source="input_contigs_db" label="${tool.name} on ${on_string}: Contigs Db"/>
        <data name="output_dir" format="anvio_profile_db" format_source="input_output_dir" metadata_source="input_output_dir" label="${tool.name} on ${on_string}: Output Dir"/>
        <data name="GALAXY_ANVIO_LOG" format="txt" label="${tool.name} on ${on_string}: Log"/>
    </outputs>
    <help><![CDATA[
        usage: anvi-profile [-h] [-i INPUT_BAM] [-c CONTIGS_DB]
                              [--blank-profile] [-o DIR_PATH] [-W] [-S NAME]
                              [--report-variability-full]
                              [--skip-SNV-profiling] [--profile-SCVs]
                              [--description TEXT_FILE] [--include-orphans]
                              [--cluster-contigs]
                              [--skip-hierarchical-clustering]
                              [--distance DISTANCE_METRIC]
                              [--linkage LINKAGE_METHOD] [-M INT]
                              [--max-contig-length INT] [-X INT] [-V INT]
                              [--list-contigs] [--contigs-of-interest FILE]
                              [-T NUM_THREADS] [--queue-size INT]
                              [--write-buffer-size INT]

Main entry point for Post-Assembly Metagenomics Pipeline

optional arguments:
  -h, --help            show this help message and exit
  -i INPUT_BAM, --input-file INPUT_BAM
                        Sorted and indexed BAM file to analyze. Takes a long
                        time depending on the length of the file and
                        parameters used for profiling.
  -c CONTIGS_DB, --contigs-db CONTIGS_DB
                        Anvi'o contigs database generated by 'anvi-gen-
                        contigs'
  --blank-profile       If you only have contig sequences, but no mapping data
                        (i.e., you found a genome and would like to take a
                        look from it), this flag will become very hand. After
                        creating a contigs database for your contigs, you can
                        create a blank anvi'o profile database to use anvi'o
                        interactive interface with that contigs database
                        without any mapping data.
  -o DIR_PATH, --output-dir DIR_PATH
                        Directory path for output files
  -W, --overwrite-output-destinations
                        Overwrite if the output files and/or directories
                        exist.
  -S NAME, --sample-name NAME
                        It is important to set a sample name (using only ASCII
                        letters and digits and without spaces) that is unique
                        (considering all others). If you do not provide one,
                        anvi'o will try to make up one for you based on other
                        information, although, you should never let the
                        software to decide these things).
  --report-variability-full
                        One of the things anvi-profile does is to store
                        information about variable nucleotide positions.
                        Usually it does not report every variable position,
                        since not every variable position is geniune
                        variation. Say, if you have 1,000 coverage, and all
                        nucleotides at that position are Ts and only one of
                        them is a C, the confidence of that C being a real
                        variation is quite low. anvio has a simple algorithm
                        in place to reduce the impact of noise. However, using
                        this flag you can diable it and ask profiler to report
                        every single variation (which may result in very large
                        output files and millions of reports, but you are the
                        boss). Do not forget to take a look at '--min-
                        coverage-for-variability' parameter
  --skip-SNV-profiling  By default, anvi'o characterizes single-nucleotide
                        variation in each sample. The use of this flag will
                        instruct profiler to skip that step. Please remember
                        that parameters and flags must be identical between
                        different profiles using the same contigs database for
                        them to merge properly.
  --profile-SCVs        Anvi'o can perform accurate characterization of codon
                        frequencies in genes during profiling. While having
                        codon frequencies opens doors to powerful evolutionary
                        insights in downstream analyses, due to its
                        computational complexity, this feature comes 'off' by
                        default. Using this flag you can rise against the
                        authority as you always should, and make anvi'o
                        profile codons.
  --description TEXT_FILE
                        A plain text file that contains some description about
                        the project. You can use Markdwon syntax. The
                        description text will be rendered and shown in all
                        relevant interfaces, including the anvi'o interactive
                        interface, or anvi'o summary outputs.
  --include-orphans     Include orphans (paired reads that are not in a proper
                        pair). The default is to ignore orphans.
  --cluster-contigs     Single profiles are rarely used for genome binning or
                        visualization, and since clustering step increases the
                        profiling runtime for no good reason, the default
                        behavior is to not cluster contigs for individual
                        runs. However, if you are planning to do binning on
                        one sample, you must use this flag to tell anvio to
                        run cluster configurations for single runs on your
                        sample.
  --skip-hierarchical-clustering
                        If you are not planning to use the interactive
                        interface (or if you have other means to add a tree of
                        contigs in the database) you may skip the step where
                        hierarchical clustering of your items are preformed
                        based on default clustering recipes matching to your
                        database type.
  --distance DISTANCE_METRIC
                        The distance metric for the hierarchical clustering.
                        Only relevant if you are using `--cluster-contigs`
                        flag. The default is "euclidean".
  --linkage LINKAGE_METHOD
                        The linkage method for the hierarchical clustering.
                        Just like the distance metric this is only relevant if
                        you are using it with `--cluster-contigs` flag. The
                        default is "ward".
  -M INT, --min-contig-length INT
                        Minimum length of contigs in a BAM file to analyze.
                        The minimum length should be long enough for tetra-
                        nucleotide frequency analysis to be meaningful. There
                        is no way to define a golden number of minumum length
                        that would be applicable to genomes found in all
                        environments, but we chose the default to be 1000, and
                        have been happy with it. You are welcome to
                        experiment, but we advise to never go below 1,000. You
                        also should remember that the lower you go, the more
                        time it will take to analyze all contigs. You can use
                        --list-contigs parameter to have an idea how many
                        contigs would be discarded for a given M.
  --max-contig-length INT
                        Just like the minimum contig length parameter, but to
                        set a maximum. Basically this will remove any contig
                        longer than a certain value. Why would anyone need
                        this? Who knows. But if you ever do, it is here.
  -X INT, --min-mean-coverage INT
                        Minimum mean coverage for contigs to be kept in the
                        analysis. The default value is 0, which is for your
                        best interest if you are going to profile muptiple BAM
                        files which are then going to be merged for a cross-
                        sectional or time series analysis. Do not change it if
                        you are not sure this is what you want to do.
  -V INT, --min-coverage-for-variability INT
                        Minimum coverage of a nucleotide position to be
                        subjected to SNV profiling. By default, anvio will not
                        attempt to make sense of variation in a given
                        nucleotide position if it is covered less than 10X.
                        You can change that minimum using this parameter.
  --list-contigs        When declared, the program will list contigs in the
                        BAM file and exit gracefully without any further
                        analysis.
  --contigs-of-interest FILE
                        It is possible to analyze only a group of contigs from
                        a given BAM file. If you provide a text file, in which
                        every contig of interest is listed line by line, the
                        profiler would engine only on those contigs in the BAM
                        file and ignore the rest. This can be used for
                        debugging purposes, or to engine on a particular group
                        of contigs that were identified as relevant during the
                        interactive analysis.
  -T NUM_THREADS, --num-threads NUM_THREADS
                        Maximum number of threads to use for multithreading
                        whenever possible. Very conservatively, the default is
                        1. It is a good idea to not exceed the number of CPUs
                        / cores on your system. Plus, please be careful with
                        this option if you are running your commands on a SGE
                        --if you are clusterizing your runs, and asking for
                        multiple threads to use, you may deplete your
                        resources very fast.
  --queue-size INT      The queue size for worker threads to store data to
                        communicate to the main thread. The default is set by
                        the class based on the number of threads. If you have
                        *any* hesitation about whther you know what you are
                        doing, you should not change this value.
  --write-buffer-size INT
                        How many items should be kept in memory before they
                        are written do the disk. The default is 500. The
                        larger the buffer size, the less frequent the program
                        will access to the disk, yet the more memory will be
                        consumed since the processed items will be cleared off
                        the memory only after they are written to the disk.
                        The default buffer size will likely work for most
                        cases, but if you have very large contigs, you may
                        need to decrease this value. Please keep an eye on the
                        memory usage output to make sure the memory use never
                        exceeds the size of the physical memory.

INPUTS:
  There are two possible inputs for anvio profiler. You must to declare
  either of these two.

EXTRAS:
  Things that are not mandatory, but can be useful if/when declared.

HIERARCHICAL CLUSTERING:
  Do you want your splits to be clustered? Yes? No? Maybe? Remember: By
  default, anvi-profile will not perform hierarchical clustering on your
  splits; but if you use `--blank` flag, it will try. You can skip that by
  using the `--skip-hierarchical-clustering` flag.

NUMBERS:
  Defaults of these parameters will impact your analysis. You can always
  come back to them and update your profiles, but it is important to make
  sure defaults are reasonable for your sample.

CONTIGS:
  Sweet parameters of convenience

PERFORMANCE:
  Performance settings for profiler

    ]]></help>
    <citations>
        <citation type="doi">10.7717/peerj.1319</citation>
    </citations>
</tool>