<tool id="anvi_gen_variability_matrix" name="anvi-gen-variability-matrix" version="5.2">
    <description>Generate Variability Matrix</description>
    <requirements>
        <requirement type="package" version="5.2">anvio</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:" />
    </stdio>
    <version_command>anvi-gen-variability-matrix --version</version_command>
    <command><![CDATA[
        
    #if $input_summary_dict:
        cp -R '${input_summary_dict.extra_files_path}' '${output_summary_dict.extra_files_path}'
    #else
        echo ''
    #end if
 && 
cp -R '${input_contigs_db.extra_files_path}' '${output_contigs_db.extra_files_path}'
 &&
 anvi-gen-variability-matrix

#if $output_summary_dict:
     '${output_summary_dict.extra_files_path}/RUNINFO.cp'
#end if

--contigs-db '${output_contigs_db.extra_files_path}/CONTIGS.db'

--splits-of-interest '${splits_of_interest}'


#if $samples_of_interest:
    --samples-of-interest '${samples_of_interest}'
#end if


#if $str( $num_positions_from_each_split ):
    --num-positions-from-each-split '${num_positions_from_each_split}'
#end if


#if $str( $min_scatter ):
    --min-scatter '${min_scatter}'
#end if


#if $str( $min_ratio_of_competings_nts ):
    --min-ratio-of-competings-nts '${min_ratio_of_competings_nts}'
#end if


#if $output_file:
    --output-file '${output_file}'
#end if

&> '${GALAXY_ANVIO_LOG}'

 &&
ls -lahR
    ]]></command>
    <inputs>
        <param name="input_summary_dict" type="data" label="Summary Dict" format="anvio_db" optional="True" multiple="False" argument="" help="Summary file"/>
        <param name="input_contigs_db" type="data" label="Contigs Db" format="anvio_contigs_db" optional="False" multiple="False" argument="--contigs-db" help="Anvi'o contigs database generated by 'anvi-gen-contigs'"/>
        <param name="splits_of_interest" type="data" label="Splits Of Interest" format="txt" optional="False" multiple="False" argument="--splits-of-interest" help="A file with split names. There should be only one column in the file, and each line should correspond to a unique split name."/>
        <param name="samples_of_interest" type="data" label="Samples Of Interest" format="txt" optional="True" multiple="False" argument="--samples-of-interest" help="A file with samples names. There should be only one column in the file, and each line should correspond to a unique sample name (without a column header)."/>
        <param name="num_positions_from_each_split" type="integer" label="Num Positions From Each Split" value="0" optional="True" argument="--num-positions-from-each-split" help="Each split may have one or more variable positions. By default, anvi'o will report every SNV position found in a given split. This parameter will help you to define a cutoff for the maximum number of SNVs to be reported from a split (if the number of SNVs is more than the number you declare using this parameter, the positions will be randomly subsampled)."/>
        <param name="min_scatter" type="integer" label="Min Scatter" value="0" optional="True" argument="--min-scatter" help="This one is tricky. If you have N samples in your dataset, a given variable position x in one of your splits can split your N samples into `t` groups based on the identity of the variation they harbor at position x. For instance, `t` would have been 1, if all samples had the same type of variation at position x (which would not be very interesting, because in this case position x would have zero contribution to a deeper understanding of how these samples differ based on variability. When `t` &gt; 1, it would mean that identities at position x across samples do differ. But how much scattering occurs based on position x when t &gt; 1? If t=2, how many samples ended in each group? Obviously, even distribution of samples across groups may tell us something different than uneven distribution of samples across groups. So, this parameter filters out any x if 'the number of samples in the second largest group' (=scatter) is less than -m. Here is an example: lets assume you have 7 samples. While 5 of those have AG, 2 of them have TC at position x. This would mean scatter of x is 2. If you set -m to 2, this position would not be reported in your output matrix. The default value for -m is %(default)d, which means every `x` found in the database and survived previous filtering criteria will be reported. Naturally, -m can not be more than half of the number of samples. Please refer to the user documentation if this is confusing."/>
        <param name="min_ratio_of_competings_nts" type="float" label="Min Ratio Of Competings Nts" value="0" optional="True" argument="--min-ratio-of-competings-nts" help="Minimum ratio of the competing nucleotides at a given position. Default is %(default)d."/>
    </inputs>
    <outputs>
        <data name="output_summary_dict" format="anvio_db" format_source="input_summary_dict" metadata_source="input_summary_dict" label="${tool.name} on ${on_string}: Summary Dict"/>
        <data name="output_contigs_db" format="anvio_contigs_db" format_source="input_contigs_db" metadata_source="input_contigs_db" label="${tool.name} on ${on_string}: Contigs Db"/>
        <data name="output_file" format="txt" format_source="input_output_file" metadata_source="input_output_file" label="${tool.name} on ${on_string}: Output File"/>
        <data name="GALAXY_ANVIO_LOG" format="txt" label="${tool.name} on ${on_string}: Log"/>
    </outputs>
    <help><![CDATA[
        usage: anvi-gen-variability-matrix [-h] -c CONTIGS_DB --splits-of-interest FILE
                              [--samples-of-interest FILE]
                              [--num-positions-from-each-split INT] [-m INT]
                              [-r RATIO] [-o FILE_PATH]
                              SUMMARY_DICT

Generate Variability Matrix

positional arguments:
  SUMMARY_DICT          Summary file

optional arguments:
  -h, --help            show this help message and exit
  -c CONTIGS_DB, --contigs-db CONTIGS_DB
                        Anvi'o contigs database generated by 'anvi-gen-
                        contigs'
  --splits-of-interest FILE
                        A file with split names. There should be only one
                        column in the file, and each line should correspond to
                        a unique split name.
  --samples-of-interest FILE
                        A file with samples names. There should be only one
                        column in the file, and each line should correspond to
                        a unique sample name (without a column header).
  --num-positions-from-each-split INT
                        Each split may have one or more variable positions. By
                        default, anvi'o will report every SNV position found
                        in a given split. This parameter will help you to
                        define a cutoff for the maximum number of SNVs to be
                        reported from a split (if the number of SNVs is more
                        than the number you declare using this parameter, the
                        positions will be randomly subsampled).
  -m INT, --min-scatter INT
                        This one is tricky. If you have N samples in your
                        dataset, a given variable position x in one of your
                        splits can split your N samples into `t` groups based
                        on the identity of the variation they harbor at
                        position x. For instance, `t` would have been 1, if
                        all samples had the same type of variation at position
                        x (which would not be very interesting, because in
                        this case position x would have zero contribution to a
                        deeper understanding of how these samples differ based
                        on variability. When `t` > 1, it would mean that
                        identities at position x across samples do differ. But
                        how much scattering occurs based on position x when t
                        > 1? If t=2, how many samples ended in each group?
                        Obviously, even distribution of samples across groups
                        may tell us something different than uneven
                        distribution of samples across groups. So, this
                        parameter filters out any x if 'the number of samples
                        in the second largest group' (=scatter) is less than
                        -m. Here is an example: lets assume you have 7
                        samples. While 5 of those have AG, 2 of them have TC
                        at position x. This would mean scatter of x is 2. If
                        you set -m to 2, this position would not be reported
                        in your output matrix. The default value for -m is 0,
                        which means every `x` found in the database and
                        survived previous filtering criteria will be reported.
                        Naturally, -m can not be more than half of the number
                        of samples. Please refer to the user documentation if
                        this is confusing.
  -r RATIO, --min-ratio-of-competings-nts RATIO
                        Minimum ratio of the competing nucleotides at a given
                        position. Default is 0.
  -o FILE_PATH, --output-file FILE_PATH
                        File path to store results.

    ]]></help>
    <citations>
        <citation type="doi">10.7717/peerj.1319</citation>
    </citations>
</tool>